<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard & Statistik Koperasi Merah Putih</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Palette Merah Putih Modern */
            --primary: #d32f2f;
            --primary-gradient: linear-gradient(135deg, #e53935, #b71c1c);
            --aktif: #10b981;
            --non-aktif: #ef4444;
            --highlight: #f59e0b;
            --sidebar-width: 280px;
            --bg-body: #e2e8f0;
            --bg-light: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #cbd5e1;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            overflow: hidden; display: flex; flex-direction: column;
            background-color: var(--bg-body);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        header {
            background: var(--primary-gradient); 
            color: white; 
            padding: 12px 24px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1001; 
            box-shadow: var(--shadow-md);
        }

        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-brand h1 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }

        .menu-toggle-btn {
            background: rgba(255, 255, 255, 0.2); border: none; color: white;
            font-size: 18px; cursor: pointer; padding: 8px 12px; border-radius: 8px;
            transition: all 0.2s ease; margin-right: 8px; display: flex; align-items: center; justify-content: center;
        }
        .menu-toggle-btn:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.05); }

        #stats-panel { 
            font-size: 13px; font-weight: 500; background: rgba(255,255,255,0.2);
            padding: 6px 16px; border-radius: 20px; backdrop-filter: blur(5px); display: flex; align-items: center;
            justify-content: center; position: relative; overflow: hidden; cursor: pointer; min-width: 190px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease;
        }
        #stats-panel:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #total-info { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; display: flex; align-items: center; gap: 6px; }
        #stats-panel:hover #total-info { transform: translateY(-25px); opacity: 0; }
        .refresh-overlay {
            position: absolute; inset: 0; background: var(--surface); color: var(--primary);
            display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; 
            transform: translateY(25px); opacity: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; border-radius: 20px;
        }
        #stats-panel:hover .refresh-overlay { transform: translateY(0); opacity: 1; }
        .refresh-overlay i { transition: transform 0.5s ease; }
        #stats-panel:hover .refresh-overlay i { transform: rotate(180deg); }

        #admin-badge {
            background: var(--highlight); color: #fff; padding: 4px 12px; 
            border-radius: 20px; font-weight: 700; font-size: 10px; 
            display: none; margin-left: 10px; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); letter-spacing: 1px;
        }

        #layout { display: flex; flex: 1; position: relative; overflow: hidden; }

        #sidebar {
            width: var(--sidebar-width); background: var(--surface); 
            border-right: 1px solid var(--border); display: flex; flex-direction: column; 
            transition: margin-left 0.3s ease, transform 0.3s ease; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        #sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }

        .sidebar-nav { padding: 20px; flex: 1; overflow-y: auto; }
        .sidebar-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 8px;
            color: var(--text-main); text-decoration: none; font-size: 13px; font-weight: 500;
            border-radius: var(--radius-md); transition: all 0.2s ease; border: 1px solid transparent; background: var(--bg-light);
            cursor: pointer;
        }
        .sidebar-link:hover { background: #fef2f2; border-color: var(--primary); color: var(--primary); transform: translateX(5px); }
        .sidebar-link.active { background: #fef2f2; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .sidebar-link i { font-size: 16px; width: 20px; text-align: center; color: var(--primary); }

        .sidebar-footer {
            padding: 15px 20px; background: var(--bg-light); border-top: 1px solid var(--border);
            text-align: center; font-size: 11px; color: var(--text-muted); line-height: 1.6; flex-shrink: 0; letter-spacing: 0.3px;
        }

        /* --- PENGATURAN AREA KONTEN UTAMA SPA --- */
        #content-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        #view-peta { flex: 1; display: flex; flex-direction: column; padding: 16px; gap: 0; overflow: hidden; }
        #view-statistik { flex: 1; display: none; flex-direction: column; padding: 24px; gap: 20px; overflow-y: auto; background-color: var(--bg-body); }

        /* KOMPONEN VIEW PETA */
        #map-container {
            flex: 0 0 40%; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); 
            border: 1px solid var(--border); position: relative; background: #fff; display: flex; flex-direction: column;
        }
        #map { width: 100%; flex: 1; z-index: 1; }
        #map.picking-location { cursor: crosshair !important; }

        #resizer {
            height: 16px; flex-shrink: 0; cursor: row-resize; 
            display: flex; align-items: center; justify-content: center; background: transparent; margin: 2px 0; z-index: 10;
        }
        .resizer-line { width: 60px; height: 6px; background: var(--border); border-radius: 6px; transition: background 0.2s; }
        #resizer:hover .resizer-line, #resizer:active .resizer-line { background: var(--primary); }

        #table-container {
            flex: 1 1 0%; background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); 
            border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-height: 250px;
        }

        .table-header-box { padding: 16px 20px; background: #ffffff; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .th-top-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; width: 100%; }
        .th-top-row h2 { margin: 0; font-size: 14px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; }
        .table-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap;}
        
        .th-search-row {
            display: flex; align-items: center; gap: 10px; width: 100%; flex-wrap: wrap;
            background: var(--bg-light); padding: 10px; border-radius: var(--radius-md); border: 1px solid #f1f5f9;
        }

        .search-input-wrapper { flex: 2; min-width: 200px; position: relative; display: flex; align-items: center; margin: 0; }
        .search-input {
            width: 100%; padding: 10px 35px 10px 16px; border: 1px solid var(--border); 
            border-radius: 30px; outline: none; font-family: 'Inter'; font-size: 13px;
            background-color: var(--surface); transition: all 0.3s ease; margin: 0; box-sizing: border-box;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1); }
        .clear-search-btn {
            position: absolute; right: 12px; color: var(--text-muted); cursor: pointer; 
            display: none; padding: 4px; font-size: 14px; transition: color 0.2s;
        }
        .clear-search-btn:hover { color: var(--primary); }

        .filter-select { 
            flex: 1; min-width: 150px; padding: 10px 16px; border-radius: 30px; 
            border: 1px solid var(--border); font-size: 13px; font-family: 'Inter';
            background-color: var(--surface); outline: none; cursor: pointer; transition: 0.3s; margin: 0;
        }
        .filter-select:focus { border-color: var(--primary); }

        .adv-search-toggle {
            background: #e2e8f0; border: 1px solid var(--border); color: var(--text-main);
            font-size: 12px; font-weight: 600; cursor: pointer; padding: 10px 16px; border-radius: 30px; 
            transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; white-space: nowrap; margin: 0;
        }
        .adv-search-toggle:hover { background: #cbd5e1; color: var(--primary); }
        
        .adv-search-panel {
            display: none; flex-direction: row; flex-wrap: wrap; gap: 20px; 
            background: #f8fafc; padding: 15px 20px; border-radius: var(--radius-md); border: 1px solid var(--border);
        }
        .adv-search-panel.active { display: flex; }

        .filter-category { flex: 1; min-width: 160px; display: flex; flex-direction: column; gap: 8px; }
        .filter-category > span { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .cb-label { 
            display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500;
            background: var(--surface); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; color: var(--text-main);
        }
        .cb-label:hover { background: #e2e8f0; }
        .cb-input { margin: 0; cursor: pointer; accent-color: var(--primary); width: 14px; height: 14px;}

        .btn-cancel { 
            background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); 
            padding: 8px 16px; border-radius: 30px; cursor: pointer; height: fit-content; align-self: flex-end;
            font-size: 12px; font-weight: 600; font-family: 'Inter'; transition: 0.2s; white-space: nowrap; margin-bottom: 2px;
        }
        .btn-cancel:hover { background: #e2e8f0; color: var(--text-main); }

        .btn-action {
            background-color: var(--surface); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; 
            font-weight: 600; font-size: 12px; font-family: 'Inter'; padding: 8px 14px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: var(--shadow-sm);
        }
        .btn-action:hover { background-color: #f1f5f9; border-color: #94a3b8; }
        .btn-export { background-color: #10b981; color: white; border: none; }
        .btn-export:hover { background-color: #059669; border: none; color: white; transform: translateY(-1px); }

        .col-toggle-wrapper { position: relative; }
        .col-toggle-menu {
            position: absolute; top: calc(100% + 5px); right: 0; background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 10px; box-shadow: var(--shadow-lg); display: none;
            flex-direction: column; gap: 6px; z-index: 1050; min-width: 180px; max-height: 250px; overflow-y: auto;
        }
        .col-toggle-menu.show { display: flex; }

        .table-wrapper { flex: 1; overflow-y: auto; overflow-x: auto;}
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: left; white-space: nowrap; }
        
        .data-table th { 
            position: sticky; top: 0; background: #f1f5f9; padding: 10px 12px; 
            color: var(--text-muted); font-weight: 700; text-transform: uppercase; 
            font-size: 10px; letter-spacing: 0.5px; border-bottom: 2px solid var(--border); z-index: 10; cursor: pointer; user-select: none; transition: background 0.2s;
        }
        .data-table th:hover { background: #e2e8f0; color: var(--text-main); }
        .sort-icon { margin-left: 4px; opacity: 0.4; font-size: 11px; }
        .sort-icon.active { opacity: 1; color: var(--primary); }

        .data-table td { padding: 6px 12px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); vertical-align: middle; }
        .data-table tr { cursor: pointer; transition: all 0.2s; }
        .data-table tr:nth-child(even) { background: #fafafa; }
        .data-table tr:hover { background: #f1f5f9; }
        .data-table tr.selected { background: #fef2f2; }
        .data-table tr.selected td { border-bottom: 1px solid #fecaca; }
        .data-table tr.selected td:first-child { border-left: 4px solid var(--primary); }

        .status-badge {
            display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 10px;
            font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: var(--shadow-sm);
        }

        .pagination-container {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; 
            background: #f8fafc; border-top: 1px solid var(--border); font-size: 12px; font-weight: 500; color: var(--text-muted); flex-shrink: 0;
        }
        .page-btn-group { display: flex; gap: 8px; }
        .page-btn { padding: 4px 12px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; border-radius: 6px; font-weight: 600; color: var(--text-main); transition: 0.2s; }
        .page-btn:hover:not(:disabled) { background: #e2e8f0; }
        .page-btn:disabled { background: #f1f5f9; color: #cbd5e1; cursor: not-allowed; }

        #info-panel {
            position: absolute; top: 15px; right: 15px; width: 340px;
            background: rgba(255, 255, 255, 0.95); border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); z-index: 2000; display: none; flex-direction: column;
            max-height: calc(100% - 30px); border: 1px solid rgba(255,255,255,0.8); overflow: hidden;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #info-panel.minimized .detail-only { display: none; }
        #info-panel.minimized { height: 60px !important; }

        .panel-header {
            background: transparent; color: var(--text-main); padding: 16px 20px; 
            cursor: grab; display: flex; justify-content: space-between; align-items: flex-start;
            min-height: 60px; box-sizing: border-box; border-bottom: 1px solid var(--border);
        }
        .panel-header:active { cursor: grabbing; }
        .panel-header h3 { margin: 0; font-size: 15px; font-weight: 700; line-height: 1.4; padding-right: 15px; flex: 1; }
        
        .panel-controls { display: flex; gap: 8px; align-items: center; margin-top: -2px; }
        .panel-controls i { cursor: pointer; font-size: 13px; color: var(--text-muted); background: #f1f5f9; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .panel-controls i:hover { background: var(--primary); color: white; transform: scale(1.05); }

        .panel-content { padding: 20px; overflow-y: auto; flex: 1; }
        .info-img { width: 100%; height: 160px; object-fit: cover; border-radius: var(--radius-md); margin-bottom: 20px; border: 1px solid var(--border); background: #f1f5f9; }
        .info-row { display: flex; flex-direction: column; margin-bottom: 14px; gap: 4px; }
        .info-row label { font-weight: 600; color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-row span { font-size: 13px; font-weight: 500; color: var(--text-main); }
        
        .edit-input { 
            width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); 
            box-sizing: border-box; font-size: 13px; font-family: 'Inter'; transition: 0.3s; background: var(--bg-light);
        }
        .edit-input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(211,47,47,0.1); }
        .btn-save { 
            background: var(--primary-gradient); color: white; border: none; padding: 12px; border-radius: var(--radius-md); 
            width: 100%; cursor: pointer; font-weight: 600; margin-top: 20px; font-family: 'Inter'; box-shadow: var(--shadow-md); transition: 0.2s;
        }
        .btn-save:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .gmaps-link { color: #2563eb; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #eff6ff; border-radius: 20px; width: fit-content; transition: 0.2s; font-size: 12px; }
        .gmaps-link:hover { background: #dbeafe; color: #1d4ed8; }

        .hint-box { background: #fffbeb; padding: 12px 16px; border-radius: var(--radius-md); border-left: 4px solid var(--highlight); font-size: 12px; margin-bottom: 20px; color: #b45309; line-height: 1.5; font-weight: 500; }

        .leaflet-tooltip-koperasi {
            background: rgba(30, 41, 59, 0.95); color: white; border: none; font-weight: 600; border-radius: 8px; 
            padding: 6px 12px; font-size: 12px; text-align: center; box-shadow: var(--shadow-md); backdrop-filter: blur(4px); font-family: 'Inter';
        }
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before, .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before { border-top-color: rgba(30, 41, 59, 0.95); }

        .custom-map-label { pointer-events: none; overflow: visible !important; }
        .custom-map-label div {
            position: absolute;
            bottom: 12px; left: 0; transform: translateX(-50%);
            font-size: 10.5px; font-family: 'Inter', sans-serif;
            font-weight: 800; color: var(--text-main);
            text-shadow: 1px 1px 0 rgba(255,255,255,0.9), -1px -1px 0 rgba(255,255,255,0.9), 1px -1px 0 rgba(255,255,255,0.9), -1px 1px 0 rgba(255,255,255,0.9);
            white-space: nowrap; text-align: center;
        }

        /* KOMPONEN VIEW STATISTIK */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .kpi-card { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 16px; border: 1px solid var(--border); transition: transform 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .kpi-icon { width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; flex-shrink: 0; }
        .icon-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .icon-green { background: linear-gradient(135deg, #10b981, #047857); }
        .icon-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .icon-orange { background: linear-gradient(135deg, #f59e0b, #b45309); }
        .kpi-details { display: flex; flex-direction: column; }
        .kpi-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .kpi-value { font-size: 28px; font-weight: 800; color: var(--text-main); line-height: 1; }

        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-card { background: var(--surface); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .chart-header { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f1f5f9; padding-bottom: 12px; }
        .chart-wrapper { position: relative; flex: 1; min-height: 300px; width: 100%; }

        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        #loader i { text-shadow: 0 4px 12px rgba(211,47,47,0.3); }

        @media (max-width: 992px) {
            #view-peta { padding: 10px; gap: 10px; overflow-y: auto; }
            #resizer { display: none; }
            #map-container { flex: none; min-height: 40vh; height: auto; }
            #table-container { flex: none; min-height: 55vh; height: auto; }
            
            #view-statistik { padding: 16px; }
            .charts-grid { grid-template-columns: 1fr; }

            header { padding: 12px 15px; flex-wrap: wrap; gap: 10px; justify-content: center;}
            .header-brand h1 { font-size: 1rem; text-align: center; }
            #stats-panel { font-size: 11px; padding: 6px 12px; min-width: 160px; }
            .refresh-overlay { font-size: 11px; }
            
            #sidebar { 
                position: absolute; left: 0; top: 0; transform: translateX(-100%); 
                height: 100%; width: 280px; max-width: 85vw; box-shadow: 5px 0 25px rgba(0,0,0,0.1); margin-left: 0 !important;
            }
            #sidebar.open { transform: translateX(0); }
            .th-search-row { flex-direction: column; align-items: stretch; background: transparent; padding: 0; border: none; }

            #info-panel { 
                position: fixed; top: auto !important; bottom: 0 !important; left: 0 !important; right: 0 !important;
                width: 100% !important; border-radius: 24px 24px 0 0 !important; max-height: 75vh; 
                border-bottom: none; border-left: none; border-right: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); z-index: 3000;
            }
            .panel-header { cursor: default; } 
            .panel-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 5px; background: #cbd5e1; border-radius: 10px; }
        }
        /* Slider Container */
        .slider-container { position: relative; width: 100%; height: 160px; margin-bottom: 20px; border-radius: var(--radius-md); overflow: hidden; background: #f1f5f9; border: 1px solid var(--border); }
        .slider-images { display: flex; transition: transform 0.3s ease-in-out; height: 100%; }
        .slider-images img { width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: 0.2s; }
        .slider-btn:hover { background: rgba(0,0,0,0.8); }
        .slider-btn.prev { left: 8px; }
        .slider-btn.next { right: 8px; }
        .slider-indicators { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; }
        .indicator { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.5); }
        .indicator.active { background: white; }
        
        /* Lightbox Overlay */
        #lightbox-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        #lightbox-img { max-width: 90%; max-height: 85vh; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); object-fit: contain; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; background: transparent; border: none; }
        .lightbox-close:hover { color: var(--primary); }
    </style>
</head>
<body>
    <div id="lightbox-overlay" onclick="closeLightbox()">
    <button class="lightbox-close"><i class="fas fa-times"></i></button>
    <img id="lightbox-img" src="" alt="Fullscreen Image" onclick="event.stopPropagation()">
    </div>
    <div id="loader">
        <i class="fas fa-circle-notch fa-spin fa-4x" style="color: var(--primary);"></i>
        <p id="loader-text" style="margin-top: 20px; font-weight: 600; color: var(--text-main); font-size: 1.1rem; letter-spacing: 0.5px;">Memuat Data..</p>
    </div>

    <header>
        <div class="header-brand">
            <button class="menu-toggle-btn" onclick="toggleSidebar()" title="Toggle Menu">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-map-location-dot fa-2x"></i>
            <h1>Dashboard Pemetaan Koperasi Desa/Kelurahan Merah Putih</h1>
            <div id="admin-badge"><i class="fas fa-shield-alt"></i> MODE ADMIN</div>
        </div>
        <div id="stats-panel" onclick="loadDataFromServer()" title="Klik untuk memuat ulang data dari server">
            <span id="total-info"><i class="fas fa-satellite-dish fa-spin"></i> Memuat...</span>
            <div class="refresh-overlay">
                <i class="fas fa-sync-alt"></i> Sinkronisasi Data
            </div>
        </div>
    </header>

    <div id="layout">
        <div id="mobile-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.4); z-index:999;" onclick="toggleSidebar()"></div>
        
        <aside id="sidebar">
            <div class="sidebar-nav">
                <h3 style="margin-top:0; font-size:14px; font-weight:700; color:var(--text-main); margin-bottom:15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                    <i class="fas fa-link" style="color: var(--primary); margin-right: 6px;"></i> Menu Utama
                </h3>
                <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column;">
                    <li><a onclick="switchView('peta')" id="link-peta" class="sidebar-link active"><i class="fas fa-map-marked-alt"></i> Peta Persebaran</a></li>
                    <li><a onclick="switchView('statistik')" id="link-statistik" class="sidebar-link"><i class="fas fa-chart-line"></i> Dashboard Statistik</a></li>
                    <li><a href="#" class="sidebar-link"><i class="fas fa-database"></i> Kelola Basis Data</a></li>
                </ul>
            </div>
            
            <div class="sidebar-footer">
                created by <strong>@m45y</strong><br>
                FOR LATSAR CPNS 2026<br>
                GOL III, ANGKATAN I
            </div>
        </aside>

        <div id="content-wrapper">

            <div id="view-peta">
                <div id="map-container">
                    <main id="map"></main>
                    <div id="info-panel">
                        <div class="panel-header" id="panel-header">
                            <h3 id="panel-title">Detail Koperasi</h3>
                            <div class="panel-controls">
                                <i class="fas fa-pen" id="edit-mode-btn" title="Mode Edit" style="display: none;" onclick="toggleEditMode()"></i>
                                <i class="fas fa-chevron-down" id="minimize-btn" title="Sembunyikan/Luaskan" onclick="togglePanelMinimize()"></i>
                                <i class="fas fa-xmark" title="Tutup Panel" onclick="closeInfoPanel()"></i>
                            </div>
                        </div>
                        <div class="panel-content" id="panel-content"></div>
                    </div>
                </div>

                <div id="resizer">
                    <div class="resizer-line"></div>
                </div>

                <div id="table-container">
                    <div class="table-header-box">
                        <div class="th-top-row">
                            <h2><i class="fas fa-table" style="margin-right: 6px; color:var(--text-muted);"></i> Data Koperasi</h2>
                            <div class="table-controls">
                                <span style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Tampilkan:</span>
                                <select id="itemsPerPage" class="filter-select" style="width: auto; padding: 6px 12px; margin-right: 10px; border-radius: 8px;" onchange="changeItemsPerPage()">
                                    <option value="10">10 Baris</option>
                                    <option value="20">20 Baris</option>
                                    <option value="50">50 Baris</option>
                                    <option value="100">100 Baris</option>
                                    <option value="all" selected>Semua Data</option>
                                </select>
                                <div class="col-toggle-wrapper">
                                    <button class="btn-action" onclick="toggleColMenu()">
                                        <i class="fas fa-columns"></i> Kolom <i class="fas fa-caret-down" style="margin-left:4px;"></i>
                                    </button>
                                    <div id="col-menu" class="col-toggle-menu"></div>
                                </div>
                                <button class="btn-action btn-export" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Ekspor Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="th-search-row">
                            <div class="search-input-wrapper">
                                <input type="text" id="searchInput" class="search-input" placeholder="Cari nama, desa, pengurus, NIK..." oninput="toggleClearBtn(); handleSearch()">
                                <i class="fas fa-times clear-search-btn" id="clearSearchBtn" onclick="clearSearch()" title="Bersihkan pencarian"></i>
                            </div>
                            <select id="filterKabupaten" class="filter-select" onchange="document.getElementById('searchInput').value=''; toggleClearBtn(); updateKecamatanDropdown(); handleSearch(); fitMapToFilteredBounds();">
                                <option value="">Semua Kabupaten/Kota</option>
                            </select>
                            <select id="filterKecamatan" class="filter-select" onchange="document.getElementById('searchInput').value=''; toggleClearBtn(); handleSearch(); fitMapToFilteredBounds();">
                                <option value="">Semua Kecamatan</option>
                            </select>
                            <button class="adv-search-toggle" onclick="toggleAdvSearch()">
                                <i class="fas fa-sliders-h"></i> <span>Pencarian Kategori (Lanjut)</span> <i class="fas fa-chevron-down" id="adv-search-icon"></i>
                            </button>
                        </div>

                        <div class="adv-search-panel" id="adv-search-panel">
                            <div class="filter-category"><span>Status Operasional</span><div id="cb-group-status" class="checkbox-group"></div></div>
                            <div class="filter-category"><span>Unit Gerai</span><div id="cb-group-gerai" class="checkbox-group"></div></div>
                            <div class="filter-category"><span>Riwayat RAT (Tahun)</span><div id="cb-group-rat" class="checkbox-group"></div></div>
                            <div class="filter-category"><span>Tingkat Kesehatan</span><div id="cb-group-kesehatan" class="checkbox-group"></div></div>
                            <button class="btn-cancel" onclick="resetAdvSearch()">
                                <i class="fas fa-undo-alt"></i> Bersihkan Filter Kategori
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead id="table-head"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>

                    <div class="pagination-container">
                        <span id="page-info">Menyiapkan data...</span>
                        <div class="page-btn-group">
                            <button id="btn-prev" class="page-btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
                            <button id="btn-next" class="page-btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-statistik">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon icon-blue"><i class="fas fa-building"></i></div>
                        <div class="kpi-details">
                            <span class="kpi-title">Total Koperasi</span>
                            <span class="kpi-value" id="kpi-total">0</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon icon-green"><i class="fas fa-check-circle"></i></div>
                        <div class="kpi-details">
                            <span class="kpi-title">Koperasi Aktif</span>
                            <span class="kpi-value" id="kpi-aktif">0</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon icon-red"><i class="fas fa-times-circle"></i></div>
                        <div class="kpi-details">
                            <span class="kpi-title">Tidak Aktif</span>
                            <span class="kpi-value" id="kpi-nonaktif">0</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon icon-orange"><i class="fas fa-file-signature"></i></div>
                        <div class="kpi-details">
                            <span class="kpi-title">Telah RAT (Tahun Terakhir)</span>
                            <span class="kpi-value" id="kpi-rat">0</span>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <div class="chart-header">
                            <i class="fas fa-chart-bar" style="color: var(--primary);"></i> Sebaran Koperasi Berdasarkan Kabupaten/Kota
                        </div>
                        <div class="chart-wrapper"><canvas id="barChartWilayah"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <i class="fas fa-chart-doughnut" style="color: #10b981;"></i> Status Operasional
                        </div>
                        <div class="chart-wrapper"><canvas id="doughnutChartStatus"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <i class="fas fa-heartbeat" style="color: #f59e0b;"></i> Tingkat Kesehatan Koperasi
                        </div>
                        <div class="chart-wrapper"><canvas id="pieChartKesehatan"></canvas></div>
                    </div>
                </div>
                <div style="height: 40px; flex-shrink: 0;"></div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- KONFIGURASI URL GOOGLE APPS SCRIPT WEB APP ---
        // Ganti URL ini dengan URL Web App Google Apps Script milik Anda yang telah di-deploy
        const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzdNtMcVBajPobF7xn-IRXKbyjBg3eOAz8Tb-g2e514rD31J3kI3w-nWRKViJpaEQ/exec";
        

        // --- DEKLARASI VARIABEL GLOBAL ---
        let leafletMap, markersLayer, labelsLayer, rawData = [], allMarkers = [], currentFilteredData = [], currentItem = null, isEditMode = false;
        let currentMapData = []; 
        let lastSelectedMarker = null;
        let tempEditMarker = null;
        let chartInstances = {};
        const defaultNoImage = "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";

        let currentPage = 1;
        let itemsPerPage = 'all'; 
        let sortCol = null;
        let sortAsc = true;
        let dynamicHeadersList = []; 
        
        let tableColumnsConfig = [
            { id: 'no', label: 'No', default: true },
            { id: 'nama', label: 'Nama Koperasi', default: true },
            { id: 'kabupaten', label: 'Kab/Kota', default: true },
            { id: 'kecamatan', label: 'Kecamatan', default: true },
            { id: 'desa', label: 'Desa/Kel', default: true },
            { id: 'status', label: 'Status', default: true },
            { id: 'nik', label: 'NIK', default: false },
            { id: 'nib', label: 'NIB', default: false },
            { id: 'pengurus', label: 'Pengurus', default: false },
            { id: 'gerai', label: 'Unit Gerai', default: false },
            { id: 'rat', label: 'RAT Terakhir', default: false },
            { id: 'kesehatan', label: 'Kesehatan', default: false },
            { id: 'lat', label: 'Latitude', default: false },
            { id: 'lng', label: 'Longitude', default: false }
        ];
        let visibleCols = tableColumnsConfig.filter(c => c.default).map(c => c.id);

        let canEdit = false;
        
        // --- PENGATURAN CHART.JS ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(30, 41, 59, 0.9)';
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;

        // --- SISTEM NAVIGASI SPA ---
        function switchView(viewName) {
            document.getElementById('view-peta').style.display = 'none';
            document.getElementById('view-statistik').style.display = 'none';
            
            document.getElementById('link-peta').classList.remove('active');
            document.getElementById('link-statistik').classList.remove('active');

            if (viewName === 'peta') {
                document.getElementById('view-peta').style.display = 'flex';
                document.getElementById('link-peta').classList.add('active');
                if (leafletMap) setTimeout(() => leafletMap.invalidateSize(), 200);
            } else if (viewName === 'statistik') {
                document.getElementById('view-statistik').style.display = 'flex';
                document.getElementById('link-statistik').classList.add('active');
                setTimeout(() => Object.values(chartInstances).forEach(c => c.resize()), 200);
            }

            if (window.innerWidth <= 992) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mobile-overlay').style.display = 'none';
            }
        }

        // --- CEK URL UNTUK MODE ADMIN ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('edit') === 'true') {
            canEdit = true;
            document.getElementById('admin-badge').style.display = 'inline-block';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (window.innerWidth <= 992) {
                sidebar.classList.toggle('open');
                overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
            } else {
                sidebar.classList.toggle('collapsed');
                setTimeout(() => {
                    if (leafletMap && document.getElementById('view-peta').style.display !== 'none') leafletMap.invalidateSize();
                    if (document.getElementById('view-statistik').style.display !== 'none') Object.values(chartInstances).forEach(c => c.resize());
                }, 300);
            }
        }

        function fitMapToAllMarkers() {
            setTimeout(() => {
                const layers = markersLayer.getLayers();
                if (layers.length > 0) leafletMap.fitBounds(markersLayer.getBounds(), { padding: [50, 50], maxZoom: 13, duration: 1 });
                else leafletMap.setView([-4.0, 122.5], 8); 
            }, 100);
        }

        function fitMapToFilteredBounds() {
            setTimeout(() => {
                if (currentMapData.length === 0) return;
                let bounds = L.latLngBounds();
                let hasValidCoords = false;
                currentMapData.forEach(item => {
                    const lat = parseFloat(item.lat); const lng = parseFloat(item.lng);
                    if (!isNaN(lat) && !isNaN(lng)) { bounds.extend([lat, lng]); hasValidCoords = true; }
                });
                if (hasValidCoords) leafletMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 13, duration: 1 });
            }, 100);
        }

        function exportToExcel() {
            if (currentFilteredData.length === 0) { alert("Tidak ada data untuk diekspor!"); return; }
            if (typeof XLSX === 'undefined') { alert("Pustaka export Excel sedang dimuat, coba beberapa saat lagi."); return; }
            
            const dataToExport = currentFilteredData.map((i, index) => {
                let rowObj = {
                    "No": index + 1, "Nama Koperasi": i.nama || "-", "Status": i.status || "-",
                    "Kabupaten/Kota": i.kabupaten || "-", "Kecamatan": i.kecamatan || "-",
                    "Desa/Kelurahan": i.desa || "-", "NIK": i.nik || "-", "NIB": i.nib || "-",
                    "Pengurus": i.pengurus || "-", "Unit Gerai": i.gerai || "-",
                    "RAT Terakhir": i.rat || "-", "Kesehatan": i.kesehatan || "-",
                    "Latitude": i.lat || "-", "Longitude": i.lng || "-"
                };
                dynamicHeadersList.forEach(header => { rowObj[header] = i[header] || "-"; });
                return rowObj;
            });
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Koperasi");
            XLSX.writeFile(wb, `Data_Koperasi_Merah_Putih_${new Date().getTime()}.xlsx`);
        }

        function initResizer() {
            const resizer = document.getElementById('resizer');
            const topPanel = document.getElementById('map-container');
            const bottomPanel = document.getElementById('table-container');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'row-resize'; e.preventDefault(); });
            resizer.addEventListener('touchstart', (e) => { isResizing = true; }, {passive: true});
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', (e) => { if(isResizing) handleMove(e.touches[0]); }, {passive: false});
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchend', stopResize);

            function handleMove(e) {
                if (!isResizing) return;
                const container = document.getElementById('view-peta');
                const containerRect = container.getBoundingClientRect();
                let newBasis = ((e.clientY - containerRect.top) / containerRect.height) * 100;
                if (newBasis < 20) newBasis = 20; if (newBasis > 80) newBasis = 80;
                topPanel.style.flex = `0 0 ${newBasis}%`; bottomPanel.style.flex = `1 1 0%`;
            }
            function stopResize() {
                if (isResizing) { isResizing = false; document.body.style.cursor = ''; if (leafletMap) leafletMap.invalidateSize(); }
            }
        }

        function initColMenu() {
            const menu = document.getElementById('col-menu');
            menu.innerHTML = '';
            tableColumnsConfig.forEach(col => {
                const label = document.createElement('label'); label.className = 'cb-label'; label.style.width = '100%'; label.style.boxSizing = 'border-box';
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'cb-input'; cb.value = col.id; cb.checked = visibleCols.includes(col.id);
                cb.onchange = (e) => {
                    if(e.target.checked) visibleCols.push(col.id); else visibleCols = visibleCols.filter(v => v !== col.id);
                    visibleCols.sort((a,b) => tableColumnsConfig.findIndex(c=>c.id===a) - tableColumnsConfig.findIndex(c=>c.id===b));
                    renderTable();
                };
                label.appendChild(cb); label.appendChild(document.createTextNode(' ' + col.label)); menu.appendChild(label);
            });
        }

        function toggleColMenu() { document.getElementById('col-menu').classList.toggle('show'); }
        document.addEventListener('click', (e) => { if(!e.target.closest('.col-toggle-wrapper')) { const c = document.getElementById('col-menu'); if(c) c.classList.remove('show'); } });

        function toggleAdvSearch() {
            const p = document.getElementById('adv-search-panel'); const i = document.getElementById('adv-search-icon');
            p.classList.toggle('active'); i.className = p.classList.contains('active') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }

        function populateAdvancedFilters() {
            const categories = [ { id: 'cb-group-status', key: 'status' }, { id: 'cb-group-gerai', key: 'gerai' }, { id: 'cb-group-rat', key: 'rat' }, { id: 'cb-group-kesehatan', key: 'kesehatan' } ];
            categories.forEach(cat => {
                const container = document.getElementById(cat.id); if (!container) return; container.innerHTML = '';
                const uniqueValues = [...new Set(rawData.map(i => String(i[cat.key]).trim()))].filter(v => v !== '' && v !== '-' && v !== 'undefined' && v !== 'null').sort();
                if (uniqueValues.length === 0) { container.innerHTML = '<span style="font-size:11px; color:#94a3b8; font-style:italic;">Data tidak tersedia</span>'; return; }
                uniqueValues.forEach(val => {
                    const label = document.createElement('label'); label.className = 'cb-label';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = val; cb.className = `cb-input cb-${cat.key}`;
                    cb.onchange = () => { handleSearch(); fitMapToFilteredBounds(); };
                    label.appendChild(cb); label.appendChild(document.createTextNode(' ' + val)); container.appendChild(label);
                });
            });
        }

        function toggleClearBtn() { const btn = document.getElementById('clearSearchBtn'); const input = document.getElementById('searchInput'); if(btn) btn.style.display = input.value.length > 0 ? 'block' : 'none'; }
        function clearSearch() { const input = document.getElementById('searchInput'); input.value = ''; toggleClearBtn(); handleSearch(); input.focus(); }
        function resetAdvSearch() { document.querySelectorAll('.cb-input').forEach(cb => cb.checked = false); handleSearch(); }

        function initMap() {
            const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: '© Google Satellite' });
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
            const googleTerrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Terrain' });
            const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' });
            
            leafletMap = L.map('map', { zoomControl: false, layers: [osm] }).setView([-4.0, 122.5], 8); 
            L.control.layers({ "Open Street Map": osm, "Google Satellite": satellite, "Google Terrain": googleTerrain, "ESRI": esri }, null, {position: 'bottomleft'}).addTo(leafletMap); 
            L.control.zoom({ position: 'bottomright' }).addTo(leafletMap);

            markersLayer = L.featureGroup().addTo(leafletMap);
            labelsLayer = L.featureGroup().addTo(leafletMap);

            leafletMap.on('zoomend', function() {
                if (leafletMap.getZoom() > 13.5) { if (!leafletMap.hasLayer(labelsLayer)) leafletMap.addLayer(labelsLayer); } 
                else { if (leafletMap.hasLayer(labelsLayer)) leafletMap.removeLayer(labelsLayer); }
            });
            
            makeDraggable(document.getElementById("info-panel"));
            leafletMap.on('click', onMapClickForPin);
            
            initResizer();
            loadDataFromServer();
        }

        function onMapClickForPin(e) {
            if (!isEditMode || !canEdit) return;
            document.getElementById('edit-lat').value = e.latlng.lat.toFixed(7); document.getElementById('edit-lng').value = e.latlng.lng.toFixed(7);
            if (tempEditMarker) leafletMap.removeLayer(tempEditMarker);
            tempEditMarker = L.marker(e.latlng).addTo(leafletMap);
        }

        async function loadDataFromServer() {
            document.getElementById('loader').style.display = 'flex';
            
            try {
                const response = await fetch(`${GAS_WEBAPP_URL}?action=getMapData`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const res = await response.json();

                if (res.success) {
                    rawData = res.data;
                    dynamicHeadersList = res.dynamicHeaders || [];
                    dynamicHeadersList.forEach(header => { if (!tableColumnsConfig.find(c => c.id === header)) tableColumnsConfig.push({ id: header, label: header, default: false }); });
                    
                    initColMenu(); populateKabupatenDropdown(); updateKecamatanDropdown(); populateAdvancedFilters();
                    handleSearch(); 
                    fitMapToAllMarkers();
                    
                    processDataAndRenderCharts(rawData);
                    document.getElementById('loader').style.display = 'none';
                } else {
                    document.getElementById('loader').style.display = 'none'; 
                    alert("Gagal memuat data: " + res.message);
                }
            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                console.error("Fetch error: ", error);
                alert("Gagal mengambil data dari server. Pastikan URL Web App sudah benar dan memiliki akses CORS yang sesuai.");
            }
        }

        function updateStats(data) {
            const total = data.length; const withCoords = data.filter(item => item.lat !== null && !isNaN(parseFloat(item.lat))).length;
            document.getElementById('total-info').innerHTML = `<i class="fas fa-chart-pie"></i> ${withCoords} dari ${total} Terpetakan`;
        }

        function changeItemsPerPage() { itemsPerPage = document.getElementById('itemsPerPage').value; currentPage = 1; renderTable(); }
        function nextPage() { currentPage++; renderTable(); }
        function prevPage() { if(currentPage > 1) { currentPage--; renderTable(); } }
        
        function updatePaginationUI(total) {
            const info = document.getElementById('page-info'); const btnPrev = document.getElementById('btn-prev'); const btnNext = document.getElementById('btn-next');
            if(itemsPerPage === 'all' || itemsPerPage > total) { info.innerText = `Menampilkan Semua (${total} Data)`; btnPrev.disabled = true; btnNext.disabled = true; } 
            else { const maxPage = Math.ceil(total / parseInt(itemsPerPage)) || 1; info.innerText = `Halaman ${currentPage} dari ${maxPage} (${total} total data)`; btnPrev.disabled = currentPage === 1; btnNext.disabled = currentPage >= maxPage; }
        }

        function applySort() {
            if (!sortCol) return;
            currentFilteredData.sort((a, b) => {
                let valA = a[sortCol]; let valB = b[sortCol];
                if (sortCol === 'no') { valA = parseInt(a.id); valB = parseInt(b.id); }
                valA = (valA === null || valA === undefined || valA === '-') ? '' : valA; valB = (valB === null || valB === undefined || valB === '-') ? '' : valB;
                if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '') { valA = parseFloat(valA); valB = parseFloat(valB); } 
                else { valA = valA.toString().toLowerCase(); valB = valB.toString().toLowerCase(); }
                if (valA < valB) return sortAsc ? -1 : 1; if (valA > valB) return sortAsc ? 1 : -1; return 0;
            });
        }
        function handleSort(colId) { if (sortCol === colId) { sortAsc = !sortAsc; } else { sortCol = colId; sortAsc = true; } applySort(); currentPage = 1; renderTable(); }

        function renderAllMapMarkers(dataToRender) {
            markersLayer.clearLayers(); labelsLayer.clearLayers(); allMarkers = [];
            dataToRender.forEach(item => {
                const latVal = parseFloat(item.lat); const lngVal = parseFloat(item.lng); const hasCoords = !isNaN(latVal) && !isNaN(lngVal);
                const isAktif = item.status.toLowerCase().includes("aktif") && !item.status.toLowerCase().includes("tidak");
                const baseColor = isAktif ? "var(--aktif)" : "var(--non-aktif)";
                
                if (hasCoords) {
                    const marker = L.circleMarker([latVal, lngVal], { radius: 7, fillColor: baseColor, color: "white", weight: 2, fillOpacity: 1 });
                    marker.bindTooltip(`<b>${item.nama}</b><br><small style="color: #cbd5e1; font-weight:400;">Kec. ${item.kecamatan}</small>`, { className: 'leaflet-tooltip-koperasi', direction: 'top', offset: [0, -5] });
                    marker.on('click', () => selectItem(item, marker));
                    markersLayer.addLayer(marker); allMarkers.push({ marker, data: item, baseColor });

                    const labelMarker = L.marker([latVal, lngVal], {
                        icon: L.divIcon({ className: 'custom-map-label', html: `<div>${item.nama}</div>`, iconSize: [0, 0], iconAnchor: [0, 0] }), interactive: false 
                    });
                    labelsLayer.addLayer(labelMarker);
                }
            });
            if (leafletMap.getZoom() <= 13.5) { if (leafletMap.hasLayer(labelsLayer)) leafletMap.removeLayer(labelsLayer); }
        }

        function renderTable() {
            const thead = document.getElementById('table-head'); const tbody = document.getElementById('table-body');
            thead.innerHTML = ''; const trHead = document.createElement('tr');
            tableColumnsConfig.forEach(col => {
                if(visibleCols.includes(col.id)) {
                    const th = document.createElement('th');
                    let sortIconClass = 'fa-sort'; let iconActive = '';
                    if (sortCol === col.id) { sortIconClass = sortAsc ? 'fa-sort-up' : 'fa-sort-down'; iconActive = 'active'; }
                    th.innerHTML = `${col.label} <i class="fas ${sortIconClass} sort-icon ${iconActive}"></i>`;
                    if(col.id === 'no') { th.style.width = '40px'; th.style.textAlign = 'center'; }
                    th.onclick = () => handleSort(col.id); trHead.appendChild(th);
                }
            });
            thead.appendChild(trHead);

            let dataToRender = currentFilteredData; const totalItems = dataToRender.length;
            if (itemsPerPage !== 'all') { const start = (currentPage - 1) * parseInt(itemsPerPage); dataToRender = dataToRender.slice(start, start + parseInt(itemsPerPage)); }

            tbody.innerHTML = '';
            if(dataToRender.length === 0) { tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" style="text-align:center; padding:30px; color:var(--text-muted);"><i>Data tidak ditemukan.</i></td></tr>`; updatePaginationUI(0); return; }

            dataToRender.forEach((item, index) => {
                const globalIdx = itemsPerPage === 'all' ? index + 1 : ((currentPage - 1) * parseInt(itemsPerPage)) + index + 1;
                const isAktif = item.status.toLowerCase().includes("aktif") && !item.status.toLowerCase().includes("tidak");
                const baseColor = isAktif ? "var(--aktif)" : "var(--non-aktif)";
                const hasCoords = !isNaN(parseFloat(item.lat)) && !isNaN(parseFloat(item.lng));
                const tr = document.createElement('tr'); tr.id = `row-${item.id}`;
                
                tableColumnsConfig.forEach(col => {
                    if(visibleCols.includes(col.id)) {
                        const td = document.createElement('td');
                        if (col.id === 'no') { td.innerText = globalIdx; td.style.textAlign = 'center'; td.style.color = 'var(--text-muted)'; td.style.fontWeight = '500'; } 
                        else if (col.id === 'nama') { td.innerHTML = `${item.nama} ${!hasCoords ? '<i class="fas fa-exclamation-triangle" style="color:var(--highlight); margin-left:5px; font-size:10px;" title="Belum Terpetakan"></i>' : ''}`; td.style.fontWeight = '600'; } 
                        else if (col.id === 'status') { td.innerHTML = `<span class="status-badge" style="background:${baseColor}">${item.status}</span>`; } 
                        else { td.innerText = item[col.id] || '-'; }
                        tr.appendChild(td);
                    }
                });

                tr.onclick = () => {
                    if (hasCoords) leafletMap.flyTo([parseFloat(item.lat), parseFloat(item.lng)], 18, {duration: 1.5});
                    const markerObj = allMarkers.find(m => m.data.id === item.id); selectItem(item, markerObj ? markerObj.marker : null);
                    if (window.innerWidth <= 992) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobile-overlay').style.display = 'none'; document.getElementById('view-peta').scrollTop = 0; }
                };
                tbody.appendChild(tr);
            });
            updatePaginationUI(totalItems);
        }

        function renderData() {
            currentPage = 1; applySort();     
            renderAllMapMarkers(currentMapData); updateStats(currentMapData);
            renderTable();
        }

        function selectItem(item, marker) {
            if (lastSelectedMarker) { const mData = allMarkers.find(m => m.marker === lastSelectedMarker); if(mData) lastSelectedMarker.setStyle({ radius: 7, fillColor: mData.baseColor, color: "white", weight: 2 }); }
            if (marker) { marker.setStyle({ radius: 10, fillColor: "var(--highlight)", color: "#fff", weight: 3 }); lastSelectedMarker = marker; }
            document.querySelectorAll('.data-table tr').forEach(el => el.classList.remove('selected'));
            const rowEl = document.getElementById(`row-${item.id}`); if (rowEl) { rowEl.classList.add('selected'); }
            showInfoPanel(item);
        }

        let currentSlideIndex = 0;
        let imageArray = [];
        
        function showInfoPanel(item) {
            cleanupEditUI(); currentItem = item; isEditMode = false;
            const panel = document.getElementById("info-panel"); const content = document.getElementById("panel-content");
            document.getElementById("panel-title").innerText = item.nama; document.getElementById("edit-mode-btn").style.display = canEdit ? 'flex' : 'none';
            panel.classList.remove('minimized'); document.getElementById("minimize-btn").className = "fas fa-chevron-down";
        
            // Logika Pemisahan Gambar (Mendukung banyak gambar dipisah dengan koma)
            let rawFoto = (item.foto && item.foto !== "-") ? String(item.foto).split(',') : [];
            imageArray = rawFoto.map(f => f.trim()).filter(f => f !== "");
            if (imageArray.length === 0) imageArray = [defaultNoImage];
            
            currentSlideIndex = 0;
            
            let sliderHtml = `<div class="slider-container" id="slider-container">
                <div class="slider-images" id="slider-images" style="width: ${imageArray.length * 100}%;">`;
            
            imageArray.forEach((img, idx) => {
                sliderHtml += `<img src="${img}" style="width: ${100 / imageArray.length}%" onclick="openLightbox('${img}')" onerror="this.src='${defaultNoImage}'">`;
            });
            sliderHtml += `</div>`;
        
            if (imageArray.length > 1) {
                sliderHtml += `
                    <button class="slider-btn prev" onclick="changeSlide(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="slider-btn next" onclick="changeSlide(1)"><i class="fas fa-chevron-right"></i></button>
                    <div class="slider-indicators">`;
                imageArray.forEach((_, idx) => {
                    sliderHtml += `<div class="indicator ${idx === 0 ? 'active' : ''}" id="ind-${idx}"></div>`;
                });
                sliderHtml += `</div>`;
            }
            sliderHtml += `</div>`;
        
            const isAktif = item.status.toLowerCase().includes("aktif") && !item.status.toLowerCase().includes("tidak");
            const statusColor = isAktif ? "var(--aktif)" : "var(--non-aktif)";
            const latVal = parseFloat(item.lat); const lngVal = parseFloat(item.lng); const hasCoords = !isNaN(latVal) && !isNaN(lngVal);
        
            let dynamicHtml = '';
            if (dynamicHeadersList && dynamicHeadersList.length > 0) {
                dynamicHtml += '<hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;"><div style="margin-bottom:10px;"><label style="font-size:11px; font-weight:700; color:var(--primary);">INFORMASI TAMBAHAN</label></div>';
                dynamicHeadersList.forEach(header => { const val = item[header] || '-'; dynamicHtml += `<div class="info-row"><label>${header}</label><span>${val}</span></div>`; });
            }
        
            content.innerHTML = `
                <div class="detail-only">${sliderHtml}</div>
                <div class="info-row"><label>Status Operasional</label><span style="color:${statusColor}; font-weight:700;"><i class="fas fa-circle" style="font-size:10px; margin-right:4px;"></i> ${item.status}</span></div>
                <div class="info-row"><label>Lokasi Wilayah</label><span>${item.desa}, ${item.kecamatan}, ${item.kabupaten}</span></div>
                <div class="detail-only">
                    <hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;">
                    <div class="info-row"><label>Nomor Induk Koperasi / NIB</label><span>${item.nik} / ${item.nib}</span></div>
                    <div class="info-row"><label>Nama Pengurus</label><span>${item.pengurus}</span></div>
                    <div class="info-row"><label>Unit Gerai Usaha</label><span>${item.gerai}</span></div>
                    <div class="info-row"><label>Riwayat RAT</label><span>${item.rat}</span></div>
                    <div class="info-row"><label>Penilaian Kesehatan</label><span>${item.kesehatan}</span></div>
                    ${dynamicHtml}
                    <div class="info-row" style="margin-top: 15px;"><label>Navigasi Peta</label>
                        ${hasCoords ? `<a href="https://www.google.com/maps/search/?api=1&query=${latVal},${lngVal}" target="_blank" class="gmaps-link"><i class="fas fa-location-arrow"></i> Buka Rute di Google Maps</a>` : '<span style="color:var(--non-aktif); font-size:12px; font-weight:500;"><i class="fas fa-exclamation-triangle"></i> Titik koordinat belum diatur</span>'}
                    </div>
                </div>`;
            panel.style.display = 'flex';
        }
        
        function toggleEditMode() {
            if (!canEdit) return; isEditMode = true; leafletMap.getContainer().classList.add('picking-location');
            const content = document.getElementById("panel-content"); const panel = document.getElementById("info-panel");
            panel.classList.remove('minimized'); document.getElementById("minimize-btn").className = "fas fa-chevron-down";
        
            let dynamicEditHtml = '';
            if (dynamicHeadersList && dynamicHeadersList.length > 0) {
                dynamicEditHtml += '<hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;"><div style="margin-bottom:10px;"><label style="font-size:11px; font-weight:700; color:var(--primary);">UBAH INFORMASI TAMBAHAN</label></div>';
                dynamicHeadersList.forEach(header => {
                    const val = currentItem[header] === '-' ? '' : (currentItem[header] || ''); 
                    const safeId = 'edit-dyn-' + header.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    dynamicEditHtml += `<div class="info-row"><label>${header}</label><input type="text" id="${safeId}" data-header="${header}" class="edit-input dynamic-input-field" value="${val}"></div>`;
                });
            }
        
            content.innerHTML = `
                <div class="detail-only">
                    <div class="hint-box"><i class="fas fa-crosshairs"></i> Klik peta untuk ubah koordinat lokasi.</div>
                    <div class="info-row"><label>Nama Instansi Koperasi</label><input type="text" id="edit-nama" class="edit-input" value="${currentItem.nama}"></div>
                    <div class="info-row"><label>Status Koperasi</label>
                        <select id="edit-status" class="edit-input"><option value="Aktif" ${currentItem.status === 'Aktif' ? 'selected' : ''}>Aktif</option><option value="Tidak Aktif" ${currentItem.status !== 'Aktif' ? 'selected' : ''}>Tidak Aktif</option></select>
                    </div>
                    <div class="info-row"><label>Unggah Gambar Baru (Bisa Lebih Dari 1)</label>
                        <input type="file" id="upload-foto" accept="image/*" multiple style="font-size: 11px; padding: 8px 0;">
                        <button class="btn-action" style="margin-top: 4px; width: fit-content; background: #e2e8f0;" onclick="uploadImagesToServer()">
                            <i class="fas fa-cloud-upload-alt"></i> Mulai Unggah
                        </button>
                        <div id="upload-status" style="font-size: 11px; font-weight: 600; color: var(--primary); margin-top: 6px;"></div>
                    </div>
                    <div class="info-row"><label>Tautan URL Foto (Pisahkan dengan koma)</label><textarea id="edit-foto" class="edit-input" style="resize:vertical; height:60px;">${currentItem.foto === '-' ? '' : currentItem.foto}</textarea></div>
                    <div class="info-row"><label>Unit Gerai</label><input type="text" id="edit-gerai" class="edit-input" value="${currentItem.gerai}"></div>
                    <div class="info-row"><label>RAT Terakhir</label><input type="text" id="edit-rat" class="edit-input" value="${currentItem.rat}"></div>
                    <div class="info-row"><label>Tingkat Kesehatan</label><input type="text" id="edit-kesehatan" class="edit-input" value="${currentItem.kesehatan}"></div>
                    <div style="display:flex; gap:12px">
                       <div class="info-row" style="flex:1"><label>Latitude (Y)</label><input type="text" id="edit-lat" class="edit-input" value="${currentItem.lat || ''}"></div>
                       <div class="info-row" style="flex:1"><label>Longitude (X)</label><input type="text" id="edit-lng" class="edit-input" value="${currentItem.lng || ''}"></div>
                    </div>
                    ${dynamicEditHtml}
                    <button class="btn-save" onclick="saveData()"><i class="fas fa-cloud-arrow-up"></i> Terapkan Pembaruan</button>
                    <button class="btn-cancel" onclick="showInfoPanel(currentItem)">Batalkan</button>
                </div>`;
        }
        
        // Logika Navigasi Slider Gambar
        function changeSlide(direction) {
            currentSlideIndex += direction;
            if (currentSlideIndex < 0) currentSlideIndex = imageArray.length - 1;
            if (currentSlideIndex >= imageArray.length) currentSlideIndex = 0;
            
            document.getElementById("slider-images").style.transform = `translateX(-${(currentSlideIndex * 100) / imageArray.length}%)`;
            
            document.querySelectorAll('.indicator').forEach((ind, idx) => {
                ind.classList.toggle('active', idx === currentSlideIndex);
            });
        }
        
        // Logika Fullscreen Lightbox
        function openLightbox(imgSrc) {
            document.getElementById("lightbox-img").src = imgSrc;
            document.getElementById("lightbox-overlay").style.display = "flex";
        }
        function closeLightbox() {
            document.getElementById("lightbox-overlay").style.display = "none";
            document.getElementById("lightbox-img").src = "";
        }
        
        // Logika Pengunggahan Gambar ke Google Apps Script
        async function uploadImagesToServer() {
            const fileInput = document.getElementById('upload-foto');
            const statusText = document.getElementById('upload-status');
            const fotoUrlField = document.getElementById('edit-foto');
            
            if (fileInput.files.length === 0) { statusText.innerText = "Pilih file gambar terlebih dahulu."; return; }
            
            statusText.innerText = `Mengunggah 0 dari ${fileInput.files.length} gambar...`;
            statusText.style.color = "var(--highlight)";
            
            let uploadedUrls = [];
            
            for (let i = 0; i < fileInput.files.length; i++) {
                const file = fileInput.files[i];
                
                // Konversi File ke Base64
                const base64Data = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
        
                const payload = {
                    action: 'uploadImage',
                    data: base64Data,
                    mimetype: file.type,
                    filename: new Date().getTime() + "_" + file.name
                };
        
                try {
                    const response = await fetch(GAS_WEBAPP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        redirect: 'follow',
                        body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    
                    if (res.success) {
                        uploadedUrls.push(res.url);
                        statusText.innerText = `Mengunggah ${i + 1} dari ${fileInput.files.length} gambar...`;
                    } else {
                        alert(`Gagal mengunggah ${file.name}: ${res.message}`);
                    }
                } catch (err) {
                    console.error(err);
                    alert(`Koneksi terputus saat mengunggah ${file.name}`);
                }
            }
            
            if (uploadedUrls.length > 0) {
                statusText.innerText = "Berhasil diunggah!";
                statusText.style.color = "var(--aktif)";
                
                // Gabungkan URL baru dengan URL lama jika sudah ada
                const currentVal = fotoUrlField.value.trim();
                if (currentVal && currentVal !== "-") {
                    fotoUrlField.value = currentVal + ", " + uploadedUrls.join(", ");
                } else {
                    fotoUrlField.value = uploadedUrls.join(", ");
                }
            }
        }

        function togglePanelMinimize() {
            const p = document.getElementById("info-panel"); const btn = document.getElementById("minimize-btn");
            if (p.classList.contains('minimized')) { p.classList.remove('minimized'); btn.className = "fas fa-chevron-down"; } 
            else { p.classList.add('minimized'); btn.className = "fas fa-chevron-up"; }
        }

        

        async function saveData() {
            if (!canEdit) return; 
            let dynamicFieldsData = {};
            document.querySelectorAll('.dynamic-input-field').forEach(input => { 
                const headerName = input.getAttribute('data-header'); 
                dynamicFieldsData[headerName] = input.value; 
            });
            
            // Data terpisah untuk backend dan lokal
            const payloadData = {
                id: currentItem.id, nama: document.getElementById('edit-nama').value, status: document.getElementById('edit-status').value, 
                lat: document.getElementById('edit-lat').value, lng: document.getElementById('edit-lng').value, foto: document.getElementById('edit-foto').value, 
                gerai: document.getElementById('edit-gerai').value, rat: document.getElementById('edit-rat').value, kesehatan: document.getElementById('edit-kesehatan').value, 
                dynamicFields: dynamicFieldsData 
            };
        
            // Objek gabungan untuk memperbarui memori lokal (browser)
            const localUpdateData = { ...payloadData };
            delete localUpdateData.dynamicFields;
            Object.keys(dynamicFieldsData).forEach(key => { localUpdateData[key] = dynamicFieldsData[key]; });
        
            document.getElementById('loader-text').innerText = "Menyinkronkan perubahan ke Cloud..."; 
            document.getElementById('loader').style.display = 'flex';
            
            try {
                const response = await fetch(GAS_WEBAPP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'saveKoperasiData', data: payloadData })
                });
                
                const res = await response.json();
                
                if (res && res.success) { 
                    // 1. Perbarui data di memori browser tanpa fetch ulang
                    updateLocalData(localUpdateData);
                    
                    // 2. Sembunyikan loader
                    document.getElementById('loader').style.display = 'none'; 
                    
                    // 3. Render ulang elemen visual (peta, tabel, grafik) dengan data baru
                    renderData();
                    processDataAndRenderCharts(currentMapData);
                    
                    // 4. Kembalikan panel info ke mode lihat dengan data terbaru
                    const updatedItem = rawData.find(item => item.id === currentItem.id);
                    if(updatedItem) showInfoPanel(updatedItem);
                    
                } else { 
                    document.getElementById('loader').style.display = 'none'; 
                    alert("Gagal sinkronisasi data: " + (res.message || "Unknown error")); 
                }
            } catch (error) {
                document.getElementById('loader').style.display = 'none'; 
                console.error("Fetch error:", error);
                alert("Koneksi gagal: Gagal mengirim data ke server.");
            }
        }
        
        // Fungsi pembantu untuk menimpa data lama dengan data baru di memori
        function updateLocalData(newData) {
            const mergeData = (item) => {
                if (item.id === newData.id) {
                    Object.keys(newData).forEach(key => {
                        item[key] = (newData[key] !== "" && newData[key] !== null && newData[key] !== undefined) ? newData[key] : "-";
                    });
                }
            };
            rawData.forEach(mergeData);
            currentMapData.forEach(mergeData);
            currentFilteredData.forEach(mergeData);
        }

        function makeDraggable(el) {
            let p1=0, p2=0, p3=0, p4=0; const h = document.getElementById("panel-header");
            h.onmousedown = (e) => {
                if (window.innerWidth <= 992) return; 
                p3=e.clientX; p4=e.clientY; document.onmouseup = () => document.onmousemove = null;
                document.onmousemove = (e) => { p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; el.style.top=(el.offsetTop-p2)+"px"; el.style.left=(el.offsetLeft-p1)+"px"; el.style.right='auto'; el.style.bottom='auto'; }
            };
        }

        function closeInfoPanel() { cleanupEditUI(); document.getElementById("info-panel").style.display = 'none'; }
        function cleanupEditUI() { isEditMode = false; leafletMap.getContainer().classList.remove('picking-location'); if (tempEditMarker) { leafletMap.removeLayer(tempEditMarker); tempEditMarker = null; } }
        
        function populateKabupatenDropdown() { 
            const sel = document.getElementById('filterKabupaten'); const list = [...new Set(rawData.map(i => i.kabupaten))].filter(Boolean).sort();
            sel.innerHTML = '<option value="">Semua Kabupaten/Kota</option>'; list.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.text = k; sel.appendChild(opt); });
        }
        
        function updateKecamatanDropdown() { 
            const kab = document.getElementById('filterKabupaten').value; const sel = document.getElementById('filterKecamatan'); sel.innerHTML = '<option value="">Semua Kecamatan</option>';
            if (kab) { const list = [...new Set(rawData.filter(i => i.kabupaten === kab).map(i => i.kecamatan))].filter(Boolean).sort(); list.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.text = k; sel.appendChild(opt); }); }
        }
        
        function handleSearch() { 
            const q = document.getElementById('searchInput').value.toLowerCase(); const kab = document.getElementById('filterKabupaten').value; const kec = document.getElementById('filterKecamatan').value;
            const checkedStatus = Array.from(document.querySelectorAll('.cb-status:checked')).map(cb => cb.value); const checkedGerai = Array.from(document.querySelectorAll('.cb-gerai:checked')).map(cb => cb.value);
            const checkedRat = Array.from(document.querySelectorAll('.cb-rat:checked')).map(cb => cb.value); const checkedKesehatan = Array.from(document.querySelectorAll('.cb-kesehatan:checked')).map(cb => cb.value);
            
            currentMapData = rawData.filter(i => {
                const matchKab = (kab === "" || i.kabupaten === kab); const matchKec = (kec === "" || i.kecamatan === kec);
                const matchStatus = checkedStatus.length === 0 || checkedStatus.includes(String(i.status).trim()); const matchGerai = checkedGerai.length === 0 || checkedGerai.includes(String(i.gerai).trim());
                const matchRat = checkedRat.length === 0 || checkedRat.includes(String(i.rat).trim()); const matchKesehatan = checkedKesehatan.length === 0 || checkedKesehatan.includes(String(i.kesehatan).trim());
                return matchKab && matchKec && matchStatus && matchGerai && matchRat && matchKesehatan;
            });

            currentFilteredData = currentMapData.filter(i => { return (i.nama.toLowerCase().includes(q) || i.desa.toLowerCase().includes(q) || i.nik.toLowerCase().includes(q) || i.pengurus.toLowerCase().includes(q)); });
            
            renderData();
            processDataAndRenderCharts(currentMapData);
        }

        // --- FUNGSI RENDERING GRAFIK (Dari Halaman Statistik) ---
        function processDataAndRenderCharts(dataArray) {
            const totalKoperasi = dataArray.length;
            let countAktif = 0, countNonAktif = 0, countRatTerbaru = 0;
            const kabCountMap = {}, statusCountMap = {}, kesehatanCountMap = {};
            const tahunSekarang = new Date().getFullYear();

            dataArray.forEach(item => {
                const statusLcase = String(item.status).toLowerCase().trim();
                const isAktif = statusLcase.includes("aktif") && !statusLcase.includes("tidak");
                if (isAktif) countAktif++; else countNonAktif++;

                const ratString = String(item.rat);
                if (ratString.includes(String(tahunSekarang)) || ratString.includes(String(tahunSekarang - 1))) countRatTerbaru++;

                const kab = item.kabupaten || "Tidak Diketahui"; kabCountMap[kab] = (kabCountMap[kab] || 0) + 1;
                const statusLabel = isAktif ? "Aktif" : "Tidak Aktif"; statusCountMap[statusLabel] = (statusCountMap[statusLabel] || 0) + 1;
                const kesehatan = item.kesehatan && item.kesehatan !== "-" ? item.kesehatan : "Belum Dinilai"; kesehatanCountMap[kesehatan] = (kesehatanCountMap[kesehatan] || 0) + 1;
            });

            document.getElementById('kpi-total').innerText = totalKoperasi; document.getElementById('kpi-aktif').innerText = countAktif;
            document.getElementById('kpi-nonaktif').innerText = countNonAktif; document.getElementById('kpi-rat').innerText = countRatTerbaru;

            renderBarChartWilayah(kabCountMap); renderDoughnutChartStatus(statusCountMap); renderPieChartKesehatan(kesehatanCountMap);
        }

        function renderBarChartWilayah(dataMap) {
            const ctx = document.getElementById('barChartWilayah').getContext('2d');
            if (chartInstances.barChart) chartInstances.barChart.destroy();
            const labels = Object.keys(dataMap).sort(); const data = labels.map(label => dataMap[label]);
            const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(211, 47, 47, 0.8)'); gradient.addColorStop(1, 'rgba(211, 47, 47, 0.2)');

            chartInstances.barChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Jumlah Koperasi', data: data, backgroundColor: gradient, borderColor: '#d32f2f', borderWidth: 1, borderRadius: 6, barPercentage: 0.6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: '#e2e8f0', borderDash: [5, 5] } }, x: { grid: { display: false } } } }
            });
        }

        function renderDoughnutChartStatus(dataMap) {
            const ctx = document.getElementById('doughnutChartStatus').getContext('2d');
            if (chartInstances.doughnutChart) chartInstances.doughnutChart.destroy();
            const labels = Object.keys(dataMap); const data = labels.map(label => dataMap[label]);
            const bgColors = labels.map(l => l === 'Aktif' ? '#10b981' : '#ef4444');

            chartInstances.doughnutChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
            });
        }

        function renderPieChartKesehatan(dataMap) {
            const ctx = document.getElementById('pieChartKesehatan').getContext('2d');
            if (chartInstances.pieChart) chartInstances.pieChart.destroy();
            const labels = Object.keys(dataMap).sort(); const data = labels.map(label => dataMap[label]);
            const bgColors = [ '#3b82f6', '#8b5cf6', '#f59e0b', '#94a3b8', '#14b8a6', '#ec4899' ];

            chartInstances.pieChart = new Chart(ctx, {
                type: 'pie',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors.slice(0, labels.length), borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
            });
        }
        
        window.onload = initMap;
    </script>
</body>
</html>
